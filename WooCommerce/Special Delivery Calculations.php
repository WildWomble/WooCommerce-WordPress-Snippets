<?php

/**
 * NOTE: This is based on Romania's counties.
 *		 Uses the table shipping_zones.sql
 * 
 * This was made for a delivery company that was using a special way of delivery goods
 * 
 * The way it works is this:
 * 
 * Each product within the site had the weight set to be as much as accurate, in the cart, depending on the
 * County & City chosen by the customer, it would calculate the cost of the shipping based on weight
 * 
 * Example:
 * 
 * Cart Weight: 1600kg
 * County: Brasov (code BV)
 * City: Brasov
 * 
 * Given the County and City, it would check the database for the zone (there are 3 of them in this case, the further from the center of the city, the more it would cost basically)
 * 
 * Zone Returned: zone1 (for this example only)
 * Costs of the zone1 in Brasov, Brasov in the array is:
 * 
 * "zone1" => array('100' => '109', '200' => '133', '400' => '166', '800' => '175', '1200' => '199')
 * 
 * The calculation based on the given zone and cart weight is:
 * 
 * 1200kg -> 199 RON
 * 400kg  -> 166 RON
 * 
 * Shipping cost: 365 RON
 * 
 * In case of zone2 the shipping cost would be: 425 RON
 * In case of zone3 the shipping cost would be: 475 RON
 * 
 * Hopefully you can understand the way it works, especially the me in the future
 */

add_filter( 'woocommerce_package_rates', 'pallexcost_transport', 10, 2 );

function pallexcost_transport( $rates, $package ) {

	$county = WC()->customer->get_shipping_state();
	$city = WC()->customer->get_shipping_city();
	$weight = WC()->cart->cart_contents_weight;
	
	if(!empty($county) && !empty($city)) { 

		$zone_code = getZonaOras($city, $county);
		$costTransport = calcShipCostByCounty($weight, $county, $zone_code);

		foreach( $rates as $rate_key => $rate ){

        	if( $rate->method_id == 'flat_rate'){
            	// Set rate cost
            	$rates[$rate_key]->cost = $costTransport * 1.154 * 1.19;
        	}

    	}

    	return $rates;
	}
}

function getZonaOras($city, $county) {

	global $wpdb;

    $zone_code = $wpdb->get_row($wpdb->prepare('select zone from shipping_zones where city = %s and county = %s', $city, $county));
    
	if(empty($zone_code)) {
		return 'zone2';
	} else {
		return $zone_code->zona;
	}
}

function calcShipCostByCounty($weight, $county, $zone_code) {

    $counties = array(
        "AB" => array(
            "zone1" => array('100' => '109', '200' => '166', '400' => '215', '800' => '224', '1200' => '269'),
            "zone2" => array('100' => '139', '200' => '196', '400' => '245', '800' => '254', '1200' => '299'),
            "zone3" => array('100' => '164', '200' => '221', '400' => '270', '800' => '279', '1200' => '324')
		),
        "AR" => array(
            "zone1" => array('100' => '109', '200' => '179', '400' => '235', '800' => '244', '1200' => '292'),
            "zone2" => array('100' => '139', '200' => '209', '400' => '265', '800' => '274', '1200' => '322'),
            "zone3" => array('100' => '164', '200' => '234', '400' => '290', '800' => '299', '1200' => '347')
      ),
        "AG" => array(
            "zone1" => array('100' => '109', '200' => '129', '400' => '160', '800' => '169', '1200' => '192'),
            "zone2" => array('100' => '139', '200' => '159', '400' => '190', '800' => '199', '1200' => '222'),
            "zone3" => array('100' => '164', '200' => '184', '400' => '215', '800' => '224', '1200' => '247')
       ),
        "BC" => array(
            "zone1" => array('100' => '109', '200' => '164', '400' => '200', '800' => '204', '1200' => '219'),
            "zone2" => array('100' => '139', '200' => '194', '400' => '230', '800' => '234', '1200' => '249'),
            "zone3" => array('100' => '164', '200' => '219', '400' => '255', '800' => '259', '1200' => '274')
       ),
        "BH" => array(
            "zone1" => array('100' => '109', '200' => '183', '400' => '241', '800' => '250', '1200' => '291'),
            "zone2" => array('100' => '139', '200' => '213', '400' => '271', '800' => '280', '1200' => '321'),
            "zone3" => array('100' => '164', '200' => '238', '400' => '296', '800' => '305', '1200' => '346')
       ),
        "BN" => array(
            "zone1" => array('100' => '109', '200' => '177', '400' => '231', '800' => '240', '1200' => '293'),
            "zone2" => array('100' => '139', '200' => '207', '400' => '261', '800' => '270', '1200' => '323'),
            "zone3" => array('100' => '164', '200' => '232', '400' => '286', '800' => '295', '1200' => '348')
      ),
        "BT" => array(
            "zone1" => array('100' => '109', '200' => '213', '400' => '263', '800' => '272', '1200' => '295'),
            "zone2" => array('100' => '139', '200' => '243', '400' => '293', '800' => '302', '1200' => '325'),
            "zone3" => array('100' => '164', '200' => '268', '400' => '318', '800' => '327', '1200' => '350')
      ),
        "BR" => array(
            "zone1" => array('100' => '109', '200' => '150', '400' => '192', '800' => '201', '1200' => '234'),
            "zone2" => array('100' => '139', '200' => '180', '400' => '222', '800' => '231', '1200' => '264'),
            "zone3" => array('100' => '164', '200' => '205', '400' => '247', '800' => '256', '1200' => '289')
      ),
        "B" => array(
            "zone1" => array('100' => '109', '200' => '124', '400' => '146', '800' => '150', '1200' => '166'),
            "zone2" => array('100' => '139', '200' => '154', '400' => '176', '800' => '180', '1200' => '196'),
            "zone3" => array('100' => '164', '200' => '179', '400' => '201', '800' => '205', '1200' => '221')
       ),
        "BV" => array(
            "zone1" => array('100' => '109', '200' => '133', '400' => '166', '800' => '175', '1200' => '199'),
            "zone2" => array('100' => '139', '200' => '163', '400' => '196', '800' => '205', '1200' => '229'),
            "zone3" => array('100' => '164', '200' => '188', '400' => '221', '800' => '230', '1200' => '254')
       ),
        "BZ" => array(
            "zone1" => array('100' => '109', '200' => '136', '400' => '170', '800' => '179', '1200' => '203'),
            "zone2" => array('100' => '139', '200' => '166', '400' => '200', '800' => '209', '1200' => '233'),
            "zone3" => array('100' => '164', '200' => '191', '400' => '225', '800' => '234', '1200' => '258')
       ),
        "CL" => array(
            "zone1" => array('100' => '109', '200' => '145', '400' => '173', '800' => '182', '1200' => '214'),
            "zone2" => array('100' => '139', '200' => '175', '400' => '203', '800' => '212', '1200' => '244'),
            "zone3" => array('100' => '164', '200' => '200', '400' => '228', '800' => '237', '1200' => '269')
       ),
        "CS" => array(
            "zone1" => array('100' => '109', '200' => '219', '400' => '278', '800' => '287', '1200' => '345'),
            "zone2" => array('100' => '139', '200' => '249', '400' => '308', '800' => '317', '1200' => '375'),
            "zone3" => array('100' => '164', '200' => '274', '400' => '333', '800' => '342', '1200' => '400')
       ),
        "CJ" => array(
            "zone1" => array('100' => '109', '200' => '171', '400' => '222', '800' => '231', '1200' => '265'),
            "zone2" => array('100' => '139', '200' => '201', '400' => '252', '800' => '261', '1200' => '295'),
            "zone3" => array('100' => '164', '200' => '226', '400' => '277', '800' => '286', '1200' => '320')
       ),
        "CT" => array(
            "zone1" => array('100' => '74', '200' => '90', '400' => '110', '800' => '121', '1200' => '145'),
            "zone2" => array('100' => '104', '200' => '120', '400' => '140', '800' => '151', '1200' => '175'),
            "zone3" => array('100' => '129', '200' => '145', '400' => '165', '800' => '176', '1200' => '200')
       ),
        "CV" => array(
            "zone1" => array('100' => '109', '200' => '178', '400' => '233', '800' => '242', '1200' => '295'),
            "zone2" => array('100' => '139', '200' => '208', '400' => '263', '800' => '272', '1200' => '325'),
            "zone3" => array('100' => '164', '200' => '233', '400' => '288', '800' => '297', '1200' => '350')
       ),
        "DB" => array(
            "zone1" => array('100' => '109', '200' => '130', '400' => '161', '800' => '170', '1200' => '194'),
            "zone2" => array('100' => '139', '200' => '160', '400' => '191', '800' => '200', '1200' => '224'),
            "zone3" => array('100' => '164', '200' => '185', '400' => '216', '800' => '225', '1200' => '249')
       ),
        "DJ" => array(
            "zone1" => array('100' => '109', '200' => '143', '400' => '181', '800' => '190', '1200' => '213'),
            "zone2" => array('100' => '139', '200' => '173', '400' => '211', '800' => '220', '1200' => '243'),
            "zone3" => array('100' => '164', '200' => '198', '400' => '236', '800' => '245', '1200' => '268')
      ),
        "GL" => array(
            "zone1" => array('100' => '109', '200' => '142', '400' => '180', '800' => '189', '1200' => '212'),
            "zone2" => array('100' => '139', '200' => '172', '400' => '210', '800' => '219', '1200' => '242'),
            "zone3" => array('100' => '164', '200' => '197', '400' => '235', '800' => '244', '1200' => '267')
       ),
        "GR" => array(
            "zone1" => array('100' => '109', '200' => '129', '400' => '151', '800' => '160', '1200' => '189'),
            "zone2" => array('100' => '139', '200' => '159', '400' => '181', '800' => '190', '1200' => '219'),
            "zone3" => array('100' => '164', '200' => '184', '400' => '206', '800' => '215', '1200' => '244')
       ),
        "GJ" => array(
            "zone1" => array('100' => '109', '200' => '162', '400' => '195', '800' => '204', '1200' => '227'),
            "zone2" => array('100' => '139', '200' => '192', '400' => '225', '800' => '234', '1200' => '257'),
            "zone3" => array('100' => '164', '200' => '217', '400' => '250', '800' => '259', '1200' => '282')
       ),
        "HR" => array(
            "zone1" => array('100' => '109', '200' => '176', '400' => '230', '800' => '238', '1200' => '288'),
            "zone2" => array('100' => '139', '200' => '206', '400' => '260', '800' => '268', '1200' => '318'),
            "zone3" => array('100' => '164', '200' => '231', '400' => '285', '800' => '293', '1200' => '343')
       ),
        "HD" => array(
            "zone1" => array('100' => '109', '200' => '170', '400' => '221', '800' => '230', '1200' => '272'),
            "zone2" => array('100' => '139', '200' => '200', '400' => '251', '800' => '260', '1200' => '302'),
            "zone3" => array('100' => '164', '200' => '225', '400' => '276', '800' => '285', '1200' => '327')
       ),
        "IL" => array(
            "zone1" => array('100' => '109', '200' => '145', '400' => '173', '800' => '182', '1200' => '214'),
            "zone2" => array('100' => '139', '200' => '175', '400' => '203', '800' => '212', '1200' => '244'),
            "zone3" => array('100' => '164', '200' => '200', '400' => '228', '800' => '237', '1200' => '269')
       ),
        "IS" => array(
            "zone1" => array('100' => '109', '200' => '178', '400' => '227', '800' => '236', '1200' => '260'),
            "zone2" => array('100' => '139', '200' => '208', '400' => '257', '800' => '266', '1200' => '290'),
            "zone3" => array('100' => '164', '200' => '233', '400' => '282', '800' => '291', '1200' => '315')
       ),
        "IF" => array(
            "zone1" => array('100' => '109', '200' => '124', '400' => '146', '800' => '150', '1200' => '166'),
            "zone2" => array('100' => '139', '200' => '154', '400' => '176', '800' => '180', '1200' => '196'),
            "zone3" => array('100' => '164', '200' => '179', '400' => '201', '800' => '205', '1200' => '221')
       ),
        "MM" => array(
            "zone1" => array('100' => '109', '200' => '187', '400' => '247', '800' => '256', '1200' => '308'),
            "zone2" => array('100' => '139', '200' => '217', '400' => '277', '800' => '286', '1200' => '338'),
            "zone3" => array('100' => '164', '200' => '242', '400' => '302', '800' => '311', '1200' => '363')
       ),
        "MH" => array(
            "zone1" => array('100' => '109', '200' => '195', '400' => '238', '800' => '247', '1200' => '270'),
            "zone2" => array('100' => '139', '200' => '225', '400' => '268', '800' => '277', '1200' => '300'),
            "zone3" => array('100' => '164', '200' => '250', '400' => '293', '800' => '302', '1200' => '325')
       ),
        "MS" => array(
            "zone1" => array('100' => '109', '200' => '168', '400' => '218', '800' => '227', '1200' => '267'),
            "zone2" => array('100' => '139', '200' => '198', '400' => '248', '800' => '257', '1200' => '297'),
            "zone3" => array('100' => '164', '200' => '223', '400' => '273', '800' => '282', '1200' => '322')
       ),
        "NT" => array(
            "zone1" => array('100' => '109', '200' => '168', '400' => '212', '800' => '221', '1200' => '244'),
            "zone2" => array('100' => '139', '200' => '198', '400' => '242', '800' => '251', '1200' => '274'),
            "zone3" => array('100' => '164', '200' => '223', '400' => '267', '800' => '276', '1200' => '299')
       ),
        "OT" => array(
            "zone1" => array('100' => '109', '200' => '143', '400' => '181', '800' => '190', '1200' => '213'),
            "zone2" => array('100' => '139', '200' => '173', '400' => '211', '800' => '220', '1200' => '243'),
            "zone3" => array('100' => '164', '200' => '198', '400' => '236', '800' => '245', '1200' => '268')
       ),
        "PH" => array(
            "zone1" => array('100' => '109', '200' => '128', '400' => '158', '800' => '167', '1200' => '188'),
            "zone2" => array('100' => '139', '200' => '158', '400' => '188', '800' => '197', '1200' => '218'),
            "zone3" => array('100' => '164', '200' => '183', '400' => '213', '800' => '222', '1200' => '243')
       ),
        "SJ" => array(
            "zone1" => array('100' => '109', '200' => '183', '400' => '241', '800' => '250', '1200' => '288'),
            "zone2" => array('100' => '139', '200' => '213', '400' => '271', '800' => '280', '1200' => '318'),
            "zone3" => array('100' => '164', '200' => '238', '400' => '296', '800' => '305', '1200' => '343')
       ),
        "SM" => array(
            "zone1" => array('100' => '109', '200' => '187', '400' => '247', '800' => '255', '1200' => '301'),
            "zone2" => array('100' => '139', '200' => '217', '400' => '277', '800' => '285', '1200' => '331'),
            "zone3" => array('100' => '164', '200' => '242', '400' => '302', '800' => '310', '1200' => '356')
       ),
        "SB" => array(
            "zone1" => array('100' => '109', '200' => '160', '400' => '198', '800' => '202', '1200' => '237'),
            "zone2" => array('100' => '139', '200' => '190', '400' => '228', '800' => '232', '1200' => '267'),
            "zone3" => array('100' => '164', '200' => '215', '400' => '253', '800' => '257', '1200' => '292')
       ),
        "SV" => array(
            "zone1" => array('100' => '109', '200' => '183', '400' => '230', '800' => '239', '1200' => '262'),
            "zone2" => array('100' => '139', '200' => '213', '400' => '260', '800' => '269', '1200' => '292'),
            "zone3" => array('100' => '164', '200' => '238', '400' => '285', '800' => '294', '1200' => '317')
       ),
        "TR" => array(
            "zone1" => array('100' => '109', '200' => '134', '400' => '159', '800' => '168', '1200' => '200'),
            "zone2" => array('100' => '139', '200' => '164', '400' => '189', '800' => '198', '1200' => '230'),
            "zone3" => array('100' => '164', '200' => '189', '400' => '214', '800' => '223', '1200' => '255')
       ),
        "TM" => array(
            "zone1" => array('100' => '109', '200' => '177', '400' => '231', '800' => '240', '1200' => '273'),
            "zone2" => array('100' => '139', '200' => '207', '400' => '261', '800' => '270', '1200' => '303'),
            "zone3" => array('100' => '164', '200' => '232', '400' => '286', '800' => '295', '1200' => '328')
       ),
        "TL" => array(
            "zone1" => array('100' => '109', '200' => '123', '400' => '144', '800' => '148', '1200' => '168'),
            "zone2" => array('100' => '139', '200' => '153', '400' => '174', '800' => '178', '1200' => '198'),
            "zone3" => array('100' => '164', '200' => '178', '400' => '199', '800' => '203', '1200' => '223')
       ),
        "VL" => array(
            "zone1" => array('100' => '109', '200' => '132', '400' => '165', '800' => '174', '1200' => '197'),
            "zone2" => array('100' => '139', '200' => '162', '400' => '195', '800' => '204', '1200' => '227'),
            "zone3" => array('100' => '164', '200' => '187', '400' => '220', '800' => '229', '1200' => '252')
       ),
        "VS" => array(
            "zone1" => array('100' => '109', '200' => '178', '400' => '218', '800' => '227', '1200' => '251'),
            "zone2" => array('100' => '139', '200' => '208', '400' => '248', '800' => '257', '1200' => '281'),
            "zone3" => array('100' => '164', '200' => '233', '400' => '273', '800' => '282', '1200' => '306')
       ),
        "VN" => array(
            "zone1" => array('100' => '109', '200' => '175', '400' => '221', '800' => '230', '1200' => '253'),
            "zone2" => array('100' => '139', '200' => '205', '400' => '251', '800' => '260', '1200' => '283'),
            "zone3" => array('100' => '164', '200' => '230', '400' => '276', '800' => '285', '1200' => '308')
       )
    );

    foreach($counties[$county][$zone_code] as $pallet => $cost ) {

        if($weight <= $pallet) {
            return $cost;
        }

    }
    return $cost + calcShipCostByCounty($weight - $pallet, $county, $zone_code);
}
